machine:
    timezone: Asia/Tokyo
    services:
        - docker

test:
    override:
        - docker build -t spec-engine-dev -f Dockerfile-dev .
        - docker run \
            --rm \
            -v $(pwd):/var/my-app \
            spec-engine-dev \
                ant -f src/main/javacc/build.xml
        - docker run \
            --rm \
            -v $(pwd):/var/my-app \
            -v ~/.m2:/root/.m2 \
                spec-engine-dev
        - docker build -t u6kapps/spec-engine .
    post:
        - cp -r target/surefire-reports/* $CIRCLE_TEST_REPORTS/
        - cp -r target/* $CIRCLE_ARTIFACTS/

deployment:
    release:
        tag: /.+/
        commands:
            - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
            - docker tag u6kapps/spec-engine u6kapps/spec-engine:$CIRCLE_TAG
            - docker push u6kapps/spec-engine
